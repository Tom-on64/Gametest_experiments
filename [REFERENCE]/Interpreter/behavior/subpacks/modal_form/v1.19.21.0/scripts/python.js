import{world,ItemStack,MinecraftItemTypes}from"mojang-minecraft";import{players,whitelist,devBuild,addon_prefix as prefix}from"scripts/credentials/access.js";import{client}from"scripts/gametests/commands/message.js";import*as rapydscript from"scripts/rapydscript/lib/rapydscript.js";import{ModalFormData,MessageFormData}from"mojang-minecraft-ui";export const formSettings={ModalForm:{dropdown:{defaultValueIndex:null},slider:{defaultValue:null},textField:{defaultValue:null},toggle:{defaultValue:null}}};world.events.beforeChat.subscribe((e=>{const{message:t,sender:o}=e;let n=o.name??o.nameTag,r=!1;if(r=!(1!=whitelist||!players.includes(n))||0==whitelist,t==`${prefix}python`&&1==r){e.cancel=!0;let t=new ItemStack(MinecraftItemTypes.enchantedBook,1);t.nameTag="§r§dPython interpreter",t.setLore(["§r§5Use this item to open Python interpreter"]),o.getComponent("minecraft:inventory").container.addItem(t),client(n,`You have been given a ${t.nameTag}`)}}));export function codeExecute(source,playerName,formSetting){let setting=formSetting,ModalForm=new ModalFormData;ModalForm.title("Python Interpreter [Prototype]"),ModalForm.textField("Text Field","Type here",setting.ModalForm.textField.defaultValue),ModalForm.show(source).then((ModalFormResponse=>{const{formValues:formValues}=ModalFormResponse;let[input]=formValues;/[a-z]/i.test(input)&&client(playerName,`${input}`);const startTime=(new Date).getTime();!0===devBuild&&console.warn(`Python: §6Program starts at: ${new Date}`);var language="Python";try{let JSCode=rapydscript.compile(`${input};`,{}).replace(/\`\{([^]+)\}\`/g,"`${$1}`");console.log(JSCode),language="JavaScript",globalThis.eval?eval(JSCode):new Function(JSCode)(),!0===devBuild&&console.warn(`Python: §aAll checks have passed. Time Duration: ${((new Date).getTime()-startTime)/1e3} seconds`),setting.ModalForm.textField.defaultValue=input}catch(e){ErrorHandiler(e,startTime,source,playerName,setting,input,language)}}))}function ErrorHandiler(e,t,o,n,r,a,i){let l=new MessageFormData;if(!0===devBuild){console.warn(`Python: §cSome checks were not successful. Time Duration: ${((new Date).getTime()-t)/1e3} seconds`);var s=e.stack?`\n${e.stack}`:"";client(n,`Dev build POV:\n§c${String(e+s)}`),s=e.stack?`\n${e.stack.split("\n").slice(0,-2).join("\n")}`:"",client(n,`Non-dev build POV:\n§c${String(e+s)}`),l.title(`Scripting Error [${i}]`).body(String(e+s)).button1("Exit").button2("Fix Your Code"),l.show(o).then((e=>{const{selection:t}=e;0===t&&(r.ModalForm.textField.defaultValue=a,codeExecute(o,n,r))}))}else{s=e.stack?`\n${e.stack.split("\n").slice(0,-2).join("\n")}`:"";client(n,`§c${String(e+s)}`),l.title(`Scripting Error [${i}]`).body(String(e+s)).button1("Exit").button2("Fix Your Code"),l.show(o).then((e=>{const{selection:t}=e;0===t&&(r.ModalForm.textField.defaultValue=a,codeExecute(o,n,r))}))}}world.events.beforeItemUse.subscribe((e=>{let{source:t,item:o}=e,n=t.name??t.nameTag;if("minecraft:enchanted_book"==o.id&&"§r§5Use this item to open Python interpreter"==o.getLore()[0]){codeExecute(t,n,formSettings)}}));